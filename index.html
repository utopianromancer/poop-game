<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜¥ í”¼í•˜ê¸° ê²Œì„ (Ddong Piha-gi) - Firebase ë¦¬ë”ë³´ë“œ ë²„ì „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        .arcade-font {
            font-family: 'Press Start 2P', cursive;
            text-shadow: 2px 2px #333;
        }
        body {
            background-color: #f0f8ff;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        #mainWrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }
        @media (min-width: 900px) {
            #mainWrapper {
                flex-direction: row;
                align-items: stretch;
            }
        }
        #gameContainer {
            width: 100%;
            max-width: 500px;
            min-height: 600px;
            border: 5px solid #6b4423;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.8s, background-image 0.8s;
            margin: 0 auto;
        }
        @media (min-width: 900px) {
            #gameContainer { flex-shrink: 0; }
        }
        #leaderboardContainer {
            background-color: #ffffff;
            border: 4px solid #4f46e5;
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            min-height: 400px;
        }
        .leaderboard-item {
            background-color: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: transform 0.1s;
        }
        .leaderboard-item.current-user {
            background-color: #ffeb3b;
            color: #333;
            font-weight: bold;
            border: 2px solid #f97316;
        }
        .stage-1 { 
            background: linear-gradient(to bottom, #87ceeb 0%, #b0e0e6 40%, #a2cd5a 85%, #6b8e23 100%);
            border-color: #38761d;
            color: #333;
        }
        .stage-2 {
            background: linear-gradient(to top, #36454F 0%, #556B73 60%, #839195 100%);
            border-color: #36454F;
            color: #ecf0f1;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }
        .stage-3 {
            background: radial-gradient(circle at center, #2c0b4d 0%, #0a011a 100%);
            border-color: #6a0dad;
            color: #fff;
        }
        .stage-4 {
            background: radial-gradient(circle at center, #111 0%, #000 50%, #440000 100%);
            border-color: #8b0000;
            color: #ccc;
        }
        .stage-5 {
            background: linear-gradient(to top, #fffacd 0%, #ffffff 50%);
            box-shadow: 0 0 50px 20px rgba(255, 215, 0, 0.8) inset;
            border-color: #ffd700;
            color: #333;
        }
        #gameCanvas {
            display: block;
            background-color: transparent;
            width: 100%;
            height: 100%;
        }
        .ui-panel {
            background-color: #6b4423;
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px;
            border-bottom: 2px solid #ffeb3b;
            min-height: 45px;
            font-size: 1.25rem;
        }
        .ui-panel .stat-group { color: #fff; }
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(107, 68, 35, 0.9);
            border: 4px solid #ffeb3b;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            color: white;
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.7);
            min-width: 260px;
        }
        .game-button {
            transition: all 0.2s;
            box-shadow: 0 4px #005600;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #007000;
        }
        .game-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #003000;
        }
        #touchControls {
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 20px;
            width: 100%;
            background-color: #6b4423;
            border-top: 2px solid #ffeb3b;
        }
        .touch-button {
            width: 80px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #a52a2a;
            color: #ecf0f1;
            border: 2px solid #ffeb3b;
            border-radius: 8px;
            font-size: 1.25rem;
            user-select: none;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.1s;
        }
        .touch-button:active {
            opacity: 1.0;
            background-color: #ff6347;
        }
        @media (min-width: 640px) {
            #touchControls { display: none; }
        }
        
        /* ìŠ¤í…Œì´ì§€ ë¼ë²¨: ê²Œì„ ë°°ê²½(ìº”ë²„ìŠ¤) ìœ„ ì¢Œì¸¡ ìƒë‹¨ì— ê³ ì • í‘œì‹œ */
        #stageLabel.stage-label {
            position: absolute;
            left: 12px;
            top: 56px; /* ìƒë‹¨ ìƒíƒœë°” ì•„ë˜ìª½ìœ¼ë¡œ ë‚´ë ¤ì„œ í”Œë ˆì´ ì˜ì—­ ì•ˆì— ë³´ì´ê²Œ */
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            line-height: 1.1;
            background: rgba(0, 0, 0, 0.35);
            color: #ffffff;
            z-index: 20;
        }
        }
    </style>
</head>
<body class="p-4">
    <div id="mainWrapper">
        <div id="gameContainer" class="stage-1">
            <div class="ui-panel arcade-font flex justify-between items-center px-2 py-2 text-lg md:text-lg">
                <div class="stat-group flex items-center space-x-1 whitespace-nowrap flex-shrink-0 text-white">
                    <span class="text-yellow-400">ì ìˆ˜:</span><span id="scoreValue">0</span>
                </div>
                <div class="stat-group flex-1 text-center text-lg text-white">
                    <span class="mr-1">ì½¤ë³´:</span>
                    <span id="comboValue" class="font-bold">0</span>
                </div>
                <div class="stat-group flex items-center space-x-1 whitespace-nowrap flex-shrink-0 text-white">
                    <span>â±ï¸</span><span id="timeValue">0.0s</span>
                </div>
            </div>
            <div id="stageLabel" class="stage-label">STAGE 1 Â· ì‹œê³¨</div>
            <canvas id="gameCanvas" width="500" height="500"></canvas>
            <div id="touchControls">
                <div id="leftButton" class="touch-button">
                    â—€
                </div>
                <div id="rightButton" class="touch-button">
                    â–¶
                </div>
            </div>
            <div id="messageBox" class="message-box hidden">
                <h2 id="messageTitle" class="arcade-font text-xl md:text-3xl mb-4 text-yellow-300"></h2>
                <div class="mb-4">
                    <label for="nicknameInput" class="block text-sm mb-1">ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 12ì)</label>
                    <input id="nicknameInput" type="text" maxlength="12" class="w-full px-2 py-1 rounded text-black text-sm" placeholder="ì˜ˆ: DDongMaster" />
                </div>
                <p id="messageText" class="text-white mb-4 text-sm"></p>
                <button id="actionButton" class="game-button arcade-font bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    ê²Œì„ ì‹œì‘
                </button>
            </div>
        </div>
        <div id="leaderboardContainer">
            <h3 class="arcade-font text-xl text-indigo-700 text-center mb-2 border-b-2 border-indigo-200 pb-2">
                ğŸ† ë¦¬ë”ë³´ë“œ (Top 10)
            </h3>
            <div id="leaderboardTabs" class="flex justify-center gap-2 mb-2 text-xs">
                <button class="lb-tab px-2 py-1 rounded bg-indigo-600 text-white" data-mode="score">ì ìˆ˜</button>
                <button class="lb-tab px-2 py-1 rounded bg-indigo-100 text-indigo-700" data-mode="time">ìƒì¡´ì‹œê°„</button>
                <button class="lb-tab px-2 py-1 rounded bg-indigo-100 text-indigo-700" data-mode="maxCombo">ìµœëŒ€ì½¤ë³´</button>
            </div>
            <p id="userIdDisplay" class="text-xs text-center text-gray-500 mb-1 whitespace-normal break-all">ID: ë¡œë”© ì¤‘...</p>
            <p id="leaderboardHint" class="text-[10px] text-center text-gray-400 mb-2">ë‹‰ë„¤ì„ + ì ìˆ˜ + ìƒì¡´ì‹œê°„ + ìµœëŒ€ì½¤ë³´ + ì¢…ë£Œ ì‹œê°„ì´ ì €ì¥ë©ë‹ˆë‹¤.</p>
            <ul id="leaderboardList" class="space-y-1">
                <li class="p-2 text-center text-gray-500">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, limit, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì • (ì§ˆë¬¸ì— ì ì–´ì¤€ ê°’ ì‚¬ìš©)
        const firebaseConfig = {
            apiKey: "AIzaSyAky3iQqgy4rUUjYlMOM_eSQ7BszEmeLmM",
            authDomain: "my-poop-game.firebaseapp.com",
            projectId: "my-poop-game",
            storageBucket: "my-poop-game.firebasestorage.app",
            messagingSenderId: "751847306028",
            appId: "1:751847306028:web:91a1cf01378925890e3289",
            measurementId: "G-KP1WVHWND4"
        };

        // ===== ì „ì—­ ìƒíƒœ =====
        const GAME_VERSION = '1.0';
        let app, db, auth;
        let userId = 'anonymous';
        let nickname = '';
        let leaderboardMode = 'score'; // score | time | maxCombo

        // ===== Firebase & ë¦¬ë”ë³´ë“œ =====
        async function setupFirebase() {
            const userIdDisplay = document.getElementById('userIdDisplay');
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID: ${userId}`;
                    } else {
                        userId = 'anonymous';
                        userIdDisplay.textContent = 'ID: anonymous';
                    }
                    fetchLeaderboard(leaderboardMode);
                });
            } catch (error) {
                console.error('Firebase ì´ˆê¸°í™”/ì¸ì¦ ì—ëŸ¬:', error);
                if (userIdDisplay) {
                    userIdDisplay.textContent = 'ID: ë¦¬ë”ë³´ë“œ ë¹„í™œì„±í™” (ì—ëŸ¬)';
                }
            }
        }

        // ì ìˆ˜ ì €ì¥ (ë‹‰ë„¤ì„ + ì ìˆ˜ + ìƒì¡´ì‹œê°„ + ìµœëŒ€ì½¤ë³´ + ì¢…ë£Œì‹œê°„)
        async function saveScore(score, time, maxCombo) {
            if (!db || score <= 0) {
                console.log('ì ìˆ˜ 0 ì´í•˜ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            try {
                await addDoc(collection(db, 'leaderboard'), {
                    nickname: nickname || 'ìµëª…',
                    score: score,
                    time: time,
                    maxCombo: maxCombo,
                    userId: userId,
                    createdAt: serverTimestamp() // ê²Œì„ ì¢…ë£Œ ì‹œê°
                });
                console.log('Score saved');
                fetchLeaderboard(leaderboardMode);
            } catch (e) {
                console.error('Error saving score: ', e);
            }
        }

        // ì§§ì€ ë‚ ì§œ í¬ë§·: YY-M-D am/pm H:MM
        function formatShortDate(date) {
            if (!date) return '';
            const yy = date.getFullYear() % 100;
            const m = date.getMonth() + 1;
            const d = date.getDate();
            let h = date.getHours();
            const min = date.getMinutes();
            const ampm = h >= 12 ? 'pm' : 'am';
            h = h % 12;
            if (h === 0) h = 12;
            const mm = String(min).padStart(2, '0');
            return `${yy}-${m}-${d} ${ampm} ${h}:${mm}`;
        }

        // ë¦¬ë”ë³´ë“œ ê°€ì ¸ì˜¤ê¸° (íƒ­ì— ë”°ë¼ ì •ë ¬ ê¸°ì¤€ ë³€ê²½)
        async function fetchLeaderboard(mode = leaderboardMode) {
            if (!db) return;
            leaderboardMode = mode;
            const list = document.getElementById('leaderboardList');
            if (list) {
                list.innerHTML = '<li class="p-2 text-center text-gray-500">ì ìˆ˜ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</li>';
            }
            try {
                let orderField = 'score';
                if (mode === 'time') orderField = 'time';
                else if (mode === 'maxCombo') orderField = 'maxCombo';

                const q = query(
                    collection(db, 'leaderboard'),
                    orderBy(orderField, 'desc'),
                    limit(10)
                );
                const snap = await getDocs(q);
                const scores = [];
                snap.forEach((doc) => scores.push(doc.data()));
                renderLeaderboard(scores, mode);
            } catch (e) {
                console.error('Error fetching leaderboard: ', e);
                if (list) {
                    list.innerHTML = '<li class="p-2 text-red-500 text-center">ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨</li>';
                }
            }
        }

        function renderLeaderboard(scores, mode = leaderboardMode) {
            const list = document.getElementById('leaderboardList');
            if (!list) return;
            list.innerHTML = '';
            if (scores.length === 0) {
                list.innerHTML = '<li class="p-2 text-center text-gray-500">ì•„ì§ ë“±ë¡ëœ ìµœê³  ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                return;
            }
            scores.forEach((data, index) => {
                const rank = index + 1;
                const isCurrentUser = data.userId === userId;
                const createdDate = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
                const timeStr = formatShortDate(createdDate);
                const survived = typeof data.time === 'number' ? `${data.time.toFixed(1)}ì´ˆ` : '-';
                const maxComboText = typeof data.maxCombo === 'number' ? `${data.maxCombo}ì½¤ë³´` : '-';

                let mainValue = '';
                if (mode === 'time') {
                    mainValue = survived;
                } else if (mode === 'maxCombo') {
                    mainValue = maxComboText;
                } else {
                    const scoreVal = typeof data.score === 'number' ? data.score : 0;
                    mainValue = `${scoreVal}ì `;
                }

                const item = document.createElement('li');
                item.className = `flex flex-col p-2 leaderboard-item ${isCurrentUser ? 'current-user' : ''} shadow-sm`;
                item.innerHTML = `
                    <div class="flex items-center text-sm mb-1">
                        <span class="w-1/6 text-center font-bold">${rank}.</span>
                        <span class="w-3/6 text-left break-all">${data.nickname || '(ìµëª…)'}</span>
                        <span class="w-2/6 text-right font-mono">${mainValue}</span>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-600">
                        <span>ì ìˆ˜: ${typeof data.score === 'number' ? data.score : 0} / ìƒì¡´: ${survived} / ìµœëŒ€: ${maxComboText}</span>
                        <span>${timeStr}</span>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // ================= ê²Œì„ ë¡œì§ =================
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase ì„¸íŒ… ì‹œì‘
            setupFirebase();

            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const gameContainer = document.getElementById('gameContainer');
            const messageBox = document.getElementById('messageBox');
            let actionButton = document.getElementById('actionButton');
            const nicknameInput = document.getElementById('nicknameInput');
            const comboValue = document.getElementById('comboValue');

            const scoreValue = document.getElementById('scoreValue');
            const timeValue = document.getElementById('timeValue');

            // ì¡°ì‘ ê°ë„ ì¡°ì ˆ ê°’ (ë” ë‘”ê°í•˜ê²Œ)
            const MAX_PLAYER_SPEED = 5;
            const ACCELERATION = 0.35;
            const FRICTION = 0.92;

            const OBJECT_SIZE = 30;
            const BONUS_OBJECT_SIZE = 30;
            const POOP_HITBOX_SIZE = 20;
            const POOP_HITBOX_OFFSET = (OBJECT_SIZE - POOP_HITBOX_SIZE) / 2;
            const BONUS_SCORE = 5;

            const FEVER_COMBO_INTERVAL = 50;
            const FEVER_DURATION = 10000;
            const SCORE_MULTIPLIER = 2;

            const FIXED_POOP_EMOJI = 'ğŸ’©';
            const FIXED_PLAYER_EMOJI = 'ğŸƒ';

            const STAGES = [
                { time: 30, name: 'ì‹œê³¨', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-1' },
                { time: 60, name: 'ë„ì‹œ', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-2' },
                { time: 120, name: 'ìš°ì£¼', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-3' },
                { time: 180, name: 'ë¸”ë™í™€', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-4' },
                { time: Infinity, name: 'ì²œêµ­', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: 'âœ¨', css_class: 'stage-5' }
            ];

            let gameState = 'menu';
            let score = 0;
            let combo = 0;
            let maxCombo = 0;
            let isFeverMode = false;
            let feverEndTime = 0;
            let lastFeverComboLevel = 0;
            let startTime = 0;
            let lastSpawnTime = 0;
            let spawnInterval = 700;
            let lastMoktakSpawnTime = 0;
            let animationFrameId;
            let currentStageIndex = 0;

            const keys = { left: false, right: false };
            const touchControls = { left: false, right: false };

            function resizeCanvas() {
                const container = gameContainer;
                canvas.width = container.clientWidth;
                const uiHeight = document.querySelector('.ui-panel').offsetHeight;
                const touchControlsElement = document.getElementById('touchControls');
                const touchHeight = (window.getComputedStyle(touchControlsElement).display !== 'none')
                    ? touchControlsElement.offsetHeight
                    : 0;
                canvas.height = container.clientHeight - uiHeight - touchHeight;
                if (player) {
                    player.y = canvas.height - player.height - 20;
                    player.x = Math.min(Math.max(player.x, -player.width / 2), canvas.width - player.width / 2);
                }
            }
            window.addEventListener('resize', resizeCanvas);

            class Player {
                constructor() {
                    this.width = 40;
                    this.height = 30;
                    this.x = canvas.width / 2 - this.width / 2;
                    this.y = canvas.height - this.height - 20;
                    this.vx = 0;
                    this.HITBOX_WIDTH = 24;
                }
                draw() {
                    ctx.font = '28px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(FIXED_PLAYER_EMOJI, this.x + this.width / 2, this.y + this.height / 2);
                }
                update() {
                    if (keys.left || touchControls.left) {
                        this.vx = Math.max(-MAX_PLAYER_SPEED, this.vx - ACCELERATION);
                    } else if (keys.right || touchControls.right) {
                        this.vx = Math.min(MAX_PLAYER_SPEED, this.vx + ACCELERATION);
                    } else {
                        this.vx *= FRICTION;
                        if (Math.abs(this.vx) < 0.1) this.vx = 0;
                    }
                    this.x += this.vx;
                    if (this.x < -this.width / 2) this.x = canvas.width - this.width / 2;
                    if (this.x > canvas.width - this.width / 2) this.x = -this.width / 2;
                }
                getBounds() {
                    const X_OFFSET = (this.width - this.HITBOX_WIDTH) / 2;
                    return {
                        x: this.x + X_OFFSET,
                        y: this.y,
                        width: this.HITBOX_WIDTH,
                        height: this.height
                    };
                }
            }

            class FallingObject {
                constructor(emoji) {
                    this.size = OBJECT_SIZE;
                    this.x = Math.random() * (canvas.width - this.size);
                    this.y = -this.size;
                    const timeElapsed = (Date.now() - startTime) / 1000;
                    const baseSpeed = 3 + Math.floor(timeElapsed / 10) * 0.5;
                    this.speed = baseSpeed + (Math.random() * 3) - 1.5;
                    this.speed = Math.max(2.5, this.speed);
                    this.emoji = emoji;
                    this.passedPlayer = false;
                }
                draw() {
                    ctx.font = `${this.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.emoji, this.x + this.size / 2, this.y + this.size / 2);
                }
                update() { this.y += this.speed; }
                getBounds() {
                    return {
                        x: this.x + POOP_HITBOX_OFFSET,
                        y: this.y + POOP_HITBOX_OFFSET,
                        width: POOP_HITBOX_SIZE,
                        height: POOP_HITBOX_SIZE
                    };
                }
            }

            class BonusObject {
                constructor() {
                    this.size = BONUS_OBJECT_SIZE;
                    this.x = Math.random() * (canvas.width - this.size);
                    this.y = -this.size;
                    const timeElapsed = (Date.now() - startTime) / 1000;
                    this.speed = 2.5 + Math.floor(timeElapsed / 10) * 0.4;
                    this.emoji = 'â­';
                }
                draw() {
                    ctx.save();
                    ctx.globalAlpha = Math.sin(Date.now() / 150) * 0.2 + 0.8;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = 'rgba(255, 255, 0, 1)';
                    ctx.font = `${this.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.emoji, this.x + this.size / 2, this.y + this.size / 2);
                    ctx.restore();
                }
                update() { this.y += this.speed; }
                getBounds() {
                    return { x: this.x, y: this.y, width: this.size, height: this.size };
                }
            }

            let player;
            let fallingObjects = [];
            let bonusObjects = [];

            function updateNicknameFromInput() {
                nickname = nicknameInput.value.trim();
            }

            nicknameInput.addEventListener('input', updateNicknameFromInput);

            function initGame() {
                if (!nickname || nickname.trim() === '') {
                    nicknameInput.focus();
                    nicknameInput.classList.add('ring', 'ring-red-400');
                    setTimeout(() => nicknameInput.classList.remove('ring', 'ring-red-400'), 600);
                    return;
                }
                gameState = 'playing';
                score = 0;
                combo = 0;
                maxCombo = 0;
                isFeverMode = false;
                feverEndTime = 0;
                lastFeverComboLevel = 0;
                startTime = Date.now();
                lastSpawnTime = 0;
                lastMoktakSpawnTime = 0;
                spawnInterval = 700;
                currentStageIndex = 0;

                player = new Player();
                fallingObjects = [];
                bonusObjects = [];

                updateStageVisuals(STAGES[0]);
                updateUI();
                hideMessageBox();
                resizeCanvas();

                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                gameLoop(performance.now());
            }

            function updateStageVisuals(stage) {
                STAGES.forEach(s => gameContainer.classList.remove(s.css_class));
                gameContainer.classList.add(stage.css_class);
                const stageLabel = document.getElementById('stageLabel');
                if (stageLabel) stageLabel.textContent = `STAGE ${currentStageIndex + 1} Â· ${stage.name}`;
            }

            function startFeverMode(now, currentComboLevel) {
                isFeverMode = true;
                feverEndTime = now + FEVER_DURATION;
                lastFeverComboLevel = currentComboLevel;
            }

            function gameLoop(currentTime) {
                if (gameState === 'playing') {
                    update(currentTime);
                    draw();
                } else if (gameState === 'paused') {
                    draw();
                } else if (gameState === 'menu' || gameState === 'gameOver') {
                    draw();
                }
                animationFrameId = requestAnimationFrame(gameLoop);
            }

            function update(time) {
                const now = Date.now();
                const timeElapsed = (now - startTime) / 1000;

                if (currentStageIndex < STAGES.length - 1 && timeElapsed >= STAGES[currentStageIndex].time) {
                    currentStageIndex++;
                    updateStageVisuals(STAGES[currentStageIndex]);
                }

                player.update();

                if (isFeverMode && now > feverEndTime) {
                    isFeverMode = false;
                }

                spawnInterval = Math.max(150, 700 - timeElapsed * 15);

                if (now - lastSpawnTime > spawnInterval) {
                    fallingObjects.push(new FallingObject(STAGES[currentStageIndex].emoji_poop));
                    lastSpawnTime = now;
                }

                fallingObjects.forEach(obj => obj.update());
                bonusObjects.forEach(obj => obj.update());

                const bonusObjectsOnScreen = bonusObjects.length;
                const timeSinceLastSpawn = now - lastMoktakSpawnTime;
                if (bonusObjectsOnScreen === 0 && timeSinceLastSpawn > 3000) {
                    bonusObjects.push(new BonusObject());
                    lastMoktakSpawnTime = now;
                }

                let successfullyDodged = [];
                fallingObjects.forEach(obj => {
                    if (obj.y > player.y + player.height && !obj.passedPlayer) {
                        obj.passedPlayer = true;
                        successfullyDodged.push(obj);
                    }
                });

                successfullyDodged.forEach(obj => {
                    combo++;
                    maxCombo = Math.max(maxCombo, combo);
                    let point = 1;
                    if (isFeverMode) point *= SCORE_MULTIPLIER;
                    score += point;
                    const currentComboLevel = Math.floor(combo / FEVER_COMBO_INTERVAL) * FEVER_COMBO_INTERVAL;
                    if (currentComboLevel > 0 && currentComboLevel > lastFeverComboLevel) {
                        startFeverMode(now, currentComboLevel);
                    }
                });

                const missedBonus = bonusObjects.filter(obj => obj.y >= canvas.height + obj.size);
                if (missedBonus.length > 0) {
                    combo = 0;
                    isFeverMode = false;
                    lastFeverComboLevel = 0;
                    lastMoktakSpawnTime = now;
                }

                fallingObjects = fallingObjects.filter(obj => obj.y < canvas.height + obj.size);
                bonusObjects = bonusObjects.filter(obj => obj.y <	canvas.height + obj.size);

                checkCollisions();
                updateUI();
            }

            function checkCollisions() {
                const playerBounds = player.getBounds();
                let moktakCollected = [];
                const now = Date.now();

                for (let i = 0; i < fallingObjects.length; i++) {
                    const obj = fallingObjects[i];
                    const objBounds = obj.getBounds();
                    if (playerBounds.x < objBounds.x + objBounds.width &&
                        playerBounds.x + playerBounds.width > objBounds.x &&
                        playerBounds.y < objBounds.y + objBounds.height &&
                        playerBounds.y + playerBounds.height > objBounds.y) {
                        endGame();
                        return;
                    }
                }

                for (let i = 0; i < bonusObjects.length; i++) {
                    const bonus = bonusObjects[i];
                    const bonusBounds = bonus.getBounds();
                    if (playerBounds.x < bonusBounds.x + bonusBounds.width &&
                        playerBounds.x + playerBounds.width > bonusBounds.x &&
                        playerBounds.y < bonusBounds.y + bonusBounds.height &&
                        playerBounds.y + playerBounds.height > bonusBounds.y) {
                        score += BONUS_SCORE;
                        moktakCollected.push(i);
                        lastMoktakSpawnTime = now;
                    }
                }
                for (let i = moktakCollected.length - 1; i >= 0; i--) {
                    bonusObjects.splice(moktakCollected[i], 1);
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0;
                if (player) player.draw();
                fallingObjects.forEach(obj => obj.draw());
                bonusObjects.forEach(obj => obj.draw());

                if (isFeverMode) {
                    ctx.save();
                    const alpha = Math.sin(Date.now() / 80) * 0.3 + 0.7;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = '#FFD700';
                    ctx.shadowColor = '#FF0000';
                    ctx.shadowBlur = 15;
                    ctx.font = '30px "Press Start 2P", cursive';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('FEVER TIME!', canvas.width / 2, canvas.height / 2);
                    ctx.restore();
                }
            }

            function updateUI() {
                const timeElapsed = gameState === 'playing' ? (Date.now() - startTime) / 1000 : 0;
                scoreValue.textContent = score;
                timeValue.textContent = `${timeElapsed.toFixed(1)}s`;
                if (comboValue) comboValue.textContent = combo;
            }

            function showMessageBox(title, text, buttonText, buttonAction, isGameOver) {
                document.getElementById('messageTitle').innerHTML = title;
                document.getElementById('messageText').innerHTML = text;
                const newActionButton = actionButton.cloneNode(true);
                actionButton.parentNode.replaceChild(newActionButton, actionButton);
                actionButton = newActionButton;
                actionButton.textContent = buttonText;
                actionButton.addEventListener('click', buttonAction);
                if (isGameOver) {
                    document.getElementById('messageText').innerHTML += '<br><span class="text-xs text-yellow-400">(R í‚¤ë¥¼ ëˆŒëŸ¬ë„ ì¬ì‹œì‘)</span>';
                }
                messageBox.classList.remove('hidden');
            }

            function hideMessageBox() {
                messageBox.classList.add('hidden');
            }

            function endGame() {
                gameState = 'gameOver';
                cancelAnimationFrame(animationFrameId);
                const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                const finalMaxCombo = maxCombo;
                if (score > 0) {
                    saveScore(score, parseFloat(finalTime), finalMaxCombo);
                }
                showMessageBox(
                    `<span class='text-3xl font-bold block text-center'>GAME OVER</span>`,
                    `ë‹‰ë„¤ì„: <b>${nickname}</b><br>ìƒì¡´ ì‹œê°„: ${finalTime}ì´ˆ<br>ì ìˆ˜: ${score}ì <br>ìµœëŒ€ ì½¤ë³´: ${finalMaxCombo}íšŒ`,
                    'ë‹¤ì‹œ ì‹œì‘',
                    initGame,
                    true
                );
                isFeverMode = false;
                updateUI();
            }

            function togglePause() {
                if (gameState === 'playing') {
                    gameState = 'paused';
                    showMessageBox(
                        'PAUSED',
                        'ESC í‚¤ ë˜ëŠ” ë²„íŠ¼ì„ ëˆŒëŸ¬ ê³„ì†í•˜ì„¸ìš”.',
                        'ê³„ì†í•˜ê¸°',
                        () => {
                            gameState = 'playing';
                            hideMessageBox();
                        },
                        false
                    );
                } else if (gameState === 'paused') {
                    gameState = 'playing';
                    hideMessageBox();
                }
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (gameState === 'playing' || gameState === 'paused') togglePause();
                }
                if (gameState === 'playing') {
                    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
                    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
                } else if (gameState === 'gameOver' && (e.key === 'r' || e.key === 'R')) {
                    initGame();
                }
            });
            document.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            });

            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');
            function handleInputStart(e, control) {
                e.preventDefault();
                if (gameState === 'playing') {
                    if (e.type.startsWith('touch')) touchControls[control] = true;
                    else keys[control] = true;
                }
            }
            function handleInputEnd(e, control) {
                e.preventDefault();
                if (e.type.startsWith('touch')) touchControls[control] = false;
                else keys[control] = false;
            }
            leftButton.addEventListener('touchstart', (e) => handleInputStart(e, 'left'), { passive: false });
            leftButton.addEventListener('touchend', (e) => handleInputEnd(e, 'left'));
            rightButton.addEventListener('touchstart', (e) => handleInputStart(e, 'right'), { passive: false });
            rightButton.addEventListener('touchend', (e) => handleInputEnd(e, 'right'));
            leftButton.addEventListener('mousedown', (e) => handleInputStart(e, 'left'));
            leftButton.addEventListener('mouseup', (e) => handleInputEnd(e, 'left'));
            rightButton.addEventListener('mousedown', (e) => handleInputStart(e, 'right'));
            rightButton.addEventListener('mouseup', (e) => handleInputEnd(e, 'right'));

            function showMenu() {
                gameState = 'menu';
                player = new Player();
                resizeCanvas();
                draw();
                showMessageBox(
                    `<span class='text-3xl font-bold block mb-2'>The Poops</span><span class='text-sm block'>(ë˜¥ í”¼í•˜ê¸° ê²Œì„)</span><span class='text-xs block'>v${GAME_VERSION}</span>`,
                    '',
                    'ê²Œì„ ì‹œì‘',
                    initGame,
                    false
                );
            }

            showMenu();

            // ë¦¬ë”ë³´ë“œ íƒ­ ë²„íŠ¼ ì´ë²¤íŠ¸
            const tabButtons = document.querySelectorAll('.lb-tab');
            tabButtons.forEach((btn) => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode || 'score';
                    leaderboardMode = mode;
                    tabButtons.forEach((b) => {
                        b.classList.remove('bg-indigo-600', 'text-white');
                        b.classList.add('bg-indigo-100', 'text-indigo-700');
                    });
                    btn.classList.remove('bg-indigo-100', 'text-indigo-700');
                    btn.classList.add('bg-indigo-600', 'text-white');
                    fetchLeaderboard(mode);
                });
            });
        });
    </script>
</body>
</html>
