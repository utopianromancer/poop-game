<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë˜¥ í”¼í•˜ê¸° ê²Œì„ (Ddong Piha-gi) - 50ì½¤ë³´/10ì´ˆ í”¼ë²„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ì»¤ìŠ¤í…€ ê²Œì„ ìŠ¤íƒ€ì¼ë§ */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        .arcade-font {
            font-family: 'Press Start 2P', cursive;
            text-shadow: 2px 2px #333;
        }

        body {
            background-color: #f0f8ff; /* í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (ê²Œì„ + ë¦¬ë”ë³´ë“œ) */
        #mainWrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }
        @media (min-width: 900px) {
            #mainWrapper {
                flex-direction: row;
                align-items: stretch;
            }
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ */
        #gameContainer {
            width: 100%;
            max-width: 500px; 
            min-height: 600px; 
            border: 5px solid #6b4423; 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative; 
            transition: background-color 0.8s, background-image 0.8s; /* ë°°ê²½ ì „í™˜ íš¨ê³¼ ê°•í™” */
            margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
        }
        @media (min-width: 900px) {
            #gameContainer {
                flex-shrink: 0;
            }
        }

        /* ë¦¬ë”ë³´ë“œ ì»¨í…Œì´ë„ˆ */
        #leaderboardContainer {
            background-color: #ffffff;
            border: 4px solid #4f46e5; /* ì¸ë””ê³  ìƒ‰ìƒ */
            border-radius: 15px;
            padding: 1rem;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            min-height: 400px;
        }

        /* ë¦¬ë”ë³´ë“œ í•­ëª© ìŠ¤íƒ€ì¼ */
        .leaderboard-item {
            background-color: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            transition: transform 0.1s;
        }
        .leaderboard-item.current-user {
            background-color: #ffeb3b; /* ë…¸ë€ìƒ‰ ê°•ì¡° */
            color: #333;
            font-weight: bold;
            border: 2px solid #f97316;
        }

        /* --- ìŠ¤í…Œì´ì§€ë³„ ë°°ê²½ CSS (ë””í…Œì¼ ê°œì„ ) --- */
        /* Stage 1: ì‹œê³¨ - í‘¸ë¥¸ í•˜ëŠ˜ê³¼ ì”ë”” */
        .stage-1 { 
            background: linear-gradient(to bottom, #87ceeb 0%, #b0e0e6 40%, #a2cd5a 85%, #6b8e23 100%); 
            border-color: #38761d; 
            color: #333;
        } 
        /* Stage 2: ë„ì‹œ - ë°¤ì˜ ìŠ¤ì¹´ì´ë¼ì¸ (ì–´ë‘ìš´ íšŒìƒ‰í†¤) */
        .stage-2 { 
            background: linear-gradient(to top, #36454F 0%, #556B73 60%, #839195 100%); 
            border-color: #36454F;
            color: #ecf0f1;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5); 
        }
        /* Stage 3: ìš°ì£¼ - ê¹Šì€ ë³´ë¼ìƒ‰, ë³„ì²˜ëŸ¼ ë³´ì´ëŠ” íŒ¨í„´ */
        .stage-3 { 
            background: radial-gradient(circle at center, #2c0b4d 0%, #0a011a 100%); 
            border-color: #6a0dad; 
            color: #fff;
            /* ì‘ì€ ë³„ì  íš¨ê³¼ë¥¼ ìœ„í•œ ë°°ê²½ ì´ë¯¸ì§€ (ì™¸ë¶€ íŒŒì¼ ì—†ì´ ìˆœìˆ˜ CSSë¡œ êµ¬í˜„í•˜ê¸° ì–´ë ¤ì›Œ ê·¸ë¼ë°ì´ì…˜ê³¼ ìƒ‰ìƒìœ¼ë¡œ ëŒ€ì²´) */
        }
        /* Stage 4: ë¸”ë™í™€ - ê°•ë ¬í•˜ê³  ì–´ë‘ìš´ ë¶‰ì€ìƒ‰ */
        .stage-4 { 
            background: radial-gradient(circle at center, #111 0%, #000 50%, #440000 100%); 
            border-color: #8b0000;
            color: #ccc;
        }
        /* Stage 5: ì²œêµ­ - ë°ê³  í™©ê¸ˆë¹›, ì—í…Œë¥´ ê°™ì€ ëŠë‚Œ */
        .stage-5 { 
            background: linear-gradient(to top, #fffacd 0%, #ffffff 50%); 
            box-shadow: 0 0 50px 20px rgba(255, 215, 0, 0.8) inset; 
            border-color: #ffd700;
            color: #333;
        }
        
        #gameCanvas {
            display: block;
            background-color: transparent; 
            width: 100%;
            height: 100%;
        }

        /* UI íŒ¨ë„ ìµœì¢… ê°œì„  ìŠ¤íƒ€ì¼ */
        .ui-panel {
            background-color: #6b4423; /* ì§„í•œ ê°ˆìƒ‰ */
            padding: 8px 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 5px; 
            border-bottom: 2px solid #ffeb3b;
            min-height: 45px; 
            font-size: 1.125rem; /* text-lg */
        }
        .ui-panel .stat-group {
             color: #fff;
        }
        
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(107, 68, 35, 0.9); 
            border: 4px solid #ffeb3b;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            color: white;
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.7);
            min-width: 250px;
        }

        .game-button {
            transition: all 0.2s;
            box-shadow: 0 4px #005600;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px #007000;
        }
        .game-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px #003000;
        }

        /* ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ */
        #touchControls {
            display: flex;
            justify-content: center;
            padding: 10px;
            gap: 20px;
            width: 100%;
            background-color: #6b4423;
            border-top: 2px solid #ffeb3b;
        }
        .touch-button {
            width: 80px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #a52a2a; 
            color: #ecf0f1;
            border: 2px solid #ffeb3b;
            border-radius: 8px;
            font-size: 1.25rem;
            user-select: none;
            cursor: pointer;
            opacity: 0.9;
            transition: opacity 0.1s;
        }
        .touch-button:active {
            opacity: 1.0;
            background-color: #ff6347;
        }
        
        @media (min-width: 640px) {
            #touchControls {
                display: none; 
            }
        }
    </style>
</head>
<body class="p-4">

    <div id="mainWrapper">
        
        <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ -->
        <div id="gameContainer" class="stage-1">
            
            <!-- UI íŒ¨ë„ (ì ìˆ˜:í…ìŠ¤íŠ¸, ì½¤ë³´:í…ìŠ¤íŠ¸, ì‹œê°„:ì´ëª¨ì§€) - text-lgë¡œ í¬ê¸° í†µì¼ -->
            <div class="ui-panel arcade-font flex justify-between items-center px-2 py-2 text-base md:text-lg">
                
                <!-- Left: Score (í…ìŠ¤íŠ¸) -->
                <div class="stat-group flex items-center space-x-1 whitespace-nowrap flex-shrink-0 text-white">
                    <span class="text-yellow-400">ì ìˆ˜:</span><span id="scoreValue">0</span>
                </div>

                <!-- Center: Combo (í¬ê¸° í†µì¼) -->
                <div id="comboDisplay" class="font-bold flex-1 text-center truncate transition-colors duration-200 text-white">
                    <span class="text-yellow-500 mr-1">ì½¤ë³´:</span>
                    <span id="comboValue">0</span>
                </div>

                <!-- Right: Time (ì´ëª¨ì§€) -->
                <div class="stat-group flex items-center space-x-1 whitespace-nowrap flex-shrink-0 text-white">
                    <span>â±ï¸</span><span id="timeValue">0.0s</span>
                </div>
            </div>
            
            <canvas id="gameCanvas" width="500" height="500"></canvas>

            <div id="touchControls">
                <div id="leftButton" class="touch-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                    </svg>
                </div>
                <div id="rightButton" class="touch-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                    </svg>
                </div>
            </div>

            <div id="messageBox" class="message-box hidden">
                <h2 id="messageTitle" class="arcade-font text-xl md:text-3xl mb-4 text-yellow-300"></h2>
                <p id="messageText" class="text-white mb-6 text-base"></p>
                <button id="actionButton" class="game-button arcade-font bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    ê²Œì„ ì‹œì‘
                </button>
            </div>
        </div>
        
        <!-- ë¦¬ë”ë³´ë“œ ì»¨í…Œì´ë„ˆ -->
        <div id="leaderboardContainer">
            <h3 class="arcade-font text-xl text-indigo-700 text-center mb-3 border-b-2 border-indigo-200 pb-2">
                ğŸ† ìµœê³  ì ìˆ˜ (Top 10)
            </h3>
            <p id="userIdDisplay" class="text-xs text-center text-gray-500 mb-4 whitespace-normal break-all">ID: ë¡œë”© ì¤‘...</p>
            <ul id="leaderboardList" class="space-y-1">
                <li class="p-2 text-center text-gray-500">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================
        // Firebase ë° ë¦¬ë”ë³´ë“œ ì„¤ì •
        // =================================
        let app, db, auth;
        let userId = 'anonymous'; 
        const leaderboardPath = (appId) => `/artifacts/${appId}/public/data/leaderboard`;

        async function setupFirebase() {
            setLogLevel('Debug');
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userIdDisplay = document.getElementById('userIdDisplay');

            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                try {
                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    await signInAnonymously(auth); 
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `ID: ${userId}`;
                    } else {
                        userId = 'anonymous';
                        userIdDisplay.textContent = `ID: anonymous`;
                    }
                    fetchLeaderboard(); 
                });
                
            } else {
                console.error("Firebase config is missing. Leaderboard disabled.");
                userIdDisplay.textContent = `ID: ë¦¬ë”ë³´ë“œ ë¹„í™œì„±í™” (ì„¤ì • ëˆ„ë½)`;
            }
        }
        
        async function saveScore(score, time) {
            if (!db || score <= 0) {
                console.log("ì ìˆ˜ê°€ 0ì  ì´í•˜ì´ë¯€ë¡œ ì €ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            try {
                await addDoc(collection(db, leaderboardPath(appId)), {
                    score: score,
                    time: time,
                    userId: userId,
                    timestamp: Date.now()
                });
                console.log("Score successfully saved:", score);
                fetchLeaderboard();
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        async function fetchLeaderboard() {
            if (!db) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '<li class="p-2 text-center text-gray-500">ì ìˆ˜ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</li>';
            
            try {
                const q = query(collection(db, leaderboardPath(appId)), limit(50)); 
                
                const querySnapshot = await getDocs(q);
                let scores = [];
                querySnapshot.forEach((doc) => {
                    scores.push(doc.data());
                });

                // ì ìˆ˜ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ, ì‹œê°„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ë©”ëª¨ë¦¬ì—ì„œ ì •ë ¬í•©ë‹ˆë‹¤.
                scores.sort((a, b) => b.score - a.score || b.time - a.time);
                
                renderLeaderboard(scores.slice(0, 10)); // ìƒìœ„ 10ê°œë§Œ ë Œë”ë§

            } catch (e) {
                console.error("Error fetching documents: ", e);
                list.innerHTML = '<li class="p-2 text-red-500 text-center">ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨ (ë¡œê·¸ í™•ì¸)</li>';
            }
        }

        function renderLeaderboard(scores) {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            
            scores.forEach((data, index) => {
                const isCurrentUser = data.userId === userId;
                const rank = index + 1;
                const userDisplay = data.userId; 
                
                const itemClass = isCurrentUser ? 'current-user' : 'leaderboard-item';
                
                const listItem = `
                    <li class="flex flex-wrap items-center p-2 ${itemClass} shadow-sm">
                        <span class="w-1/6 text-center font-bold text-sm">${rank}.</span>
                        <span class="w-4/6 text-left text-xs break-all">${isCurrentUser ? 'ë‚˜ (Me)' : userDisplay}</span>
                        <span class="w-1/6 text-right font-mono text-sm">${data.score}ì </span>
                    </li>
                `;
                list.innerHTML += listItem;
            });

            if (scores.length === 0) {
                list.innerHTML = '<li class="p-2 text-center text-gray-500">ì•„ì§ ë“±ë¡ëœ ìµœê³  ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        }


        // =================================
        // ê²Œì„ ë¡œì§
        // =================================
        document.addEventListener('DOMContentLoaded', () => {
            
            setupFirebase();

            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const gameContainer = document.getElementById('gameContainer');
            const messageBox = document.getElementById('messageBox');
            let actionButton = document.getElementById('actionButton');
            
            // UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ DOM ìš”ì†Œ
            const scoreValue = document.getElementById('scoreValue');
            const timeValue = document.getElementById('timeValue');
            const comboValue = document.getElementById('comboValue'); 
            
            // ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ì„¤ì •
            const MAX_PLAYER_SPEED = 7;
            const ACCELERATION = 0.5;
            const FRICTION = 0.9;
            const OBJECT_SIZE = 30;
            const BONUS_OBJECT_SIZE = 40;
            const POOP_HITBOX_SIZE = 20; 
            const POOP_HITBOX_OFFSET = (OBJECT_SIZE - POOP_HITBOX_SIZE) / 2;
            const BONUS_SCORE = 5; 
            const MOKTAK_SPAWN_COOLDOWN = 3000;
            
            // --- í”¼ë²„ ëª¨ë“œ ì¡°ê±´ ë° ì§€ì† ì‹œê°„ ---
            const FEVER_COMBO_INTERVAL = 50; 
            const FEVER_DURATION = 10000; // 10ì´ˆ
            const SCORE_MULTIPLIER = 2; 

            const FIXED_POOP_EMOJI = 'ğŸ’©';
            // --- ë³€ê²½ëœ ë¶€ë¶„: ì£¼ì¸ê³µ ì´ëª¨ì§€ë¥¼ 'ë‹¬ë¦¬ëŠ” ì‚¬ëŒ'ìœ¼ë¡œ ê³ ì • ---
            const FIXED_PLAYER_EMOJI = 'ğŸƒ'; 

            // ìŠ¤í…Œì´ì§€ ì •ì˜
            const STAGES = [
                { time: 30, name: 'ì‹œê³¨', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-1' },
                { time: 60, name: 'ë„ì‹œ', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-2' },
                { time: 120, name: 'ìš°ì£¼', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-3' },
                { time: 180, name: 'ë¸”ë™í™€', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: FIXED_POOP_EMOJI, css_class: 'stage-4' },
                // Stage 5ëŠ” ë˜¥ ëŒ€ì‹  ë°˜ì§ì´ëŠ” ì´ëª¨ì§€ ì‚¬ìš©
                { time: Infinity, name: 'ì²œêµ­', emoji_player: FIXED_PLAYER_EMOJI, emoji_poop: 'âœ¨', css_class: 'stage-5' } 
            ];

            
            // ê²Œì„ ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
            let gameState = 'menu'; 
            let score = 0;
            let combo = 0;
            let maxCombo = 0;
            let isFeverMode = false;
            let feverEndTime = 0;
            let lastFeverComboLevel = 0; 
            let startTime = 0;
            let lastSpawnTime = 0;
            let spawnInterval = 700; 
            let lastMoktakSpawnTime = 0;
            let animationFrameId;
            let currentStageIndex = 0;

            // í‚¤ ì…ë ¥ ìƒíƒœ
            const keys = { left: false, right: false };
            const touchControls = { left: false, right: false };
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • í•¨ìˆ˜
            function resizeCanvas() {
                const container = gameContainer;
                canvas.width = container.clientWidth;
                const uiHeight = document.querySelector('.ui-panel').offsetHeight;
                const touchControlsElement = document.getElementById('touchControls');
                const touchHeight = (window.getComputedStyle(touchControlsElement).display !== 'none') 
                                    ? touchControlsElement.offsetHeight : 0;
                
                canvas.height = container.clientHeight - uiHeight - touchHeight; 
                if (player) {
                    player.y = canvas.height - player.height - 20;
                    // í”Œë ˆì´ì–´ê°€ í™”ë©´ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ìœ„ì¹˜ ì¡°ì •
                    player.x = Math.min(Math.max(player.x, -player.width / 2), canvas.width - player.width / 2);
                }
            }

            window.addEventListener('resize', resizeCanvas);


            // 1. í”Œë ˆì´ì–´ í´ë˜ìŠ¤
            class Player {
                constructor() {
                    this.width = 40;
                    this.height = 30;
                    this.x = canvas.width / 2 - this.width / 2;
                    this.y = canvas.height - this.height - 20;
                    this.vx = 0; 
                    this.HITBOX_WIDTH = 24; // 85% íˆíŠ¸ë°•ìŠ¤ í¬ê¸° (28px -> 24px)
                }

                draw() {
                    ctx.font = '28px Arial'; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    // --- ë³€ê²½ëœ ë¶€ë¶„: ê³ ì •ëœ ì´ëª¨ì§€ ì‚¬ìš© ---
                    ctx.fillText(FIXED_PLAYER_EMOJI, this.x + this.width / 2, this.y + this.height / 2); 
                    // ----------------------------------------
                }

                update() {
                    if (keys.left || touchControls.left) {
                        this.vx = Math.max(-MAX_PLAYER_SPEED, this.vx - ACCELERATION);
                    } else if (keys.right || touchControls.right) {
                        this.vx = Math.min(MAX_PLAYER_SPEED, this.vx + ACCELERATION);
                    } else {
                        this.vx *= FRICTION;
                        if (Math.abs(this.vx) < 0.1) this.vx = 0;
                    }

                    this.x += this.vx;

                    // ë²½ í†µê³¼ ë¡œì§ ìˆ˜ì •: í”Œë ˆì´ì–´ì˜ ì¤‘ì‹¬ì´ í™”ë©´ ê°€ì¥ìë¦¬ë¥¼ ë²—ì–´ë‚˜ìë§ˆì ë°˜ëŒ€í¸ìœ¼ë¡œ ì´ë™
                    if (this.x < -this.width / 2) { 
                        this.x = canvas.width - this.width / 2;
                    }
                    if (this.x > canvas.width - this.width / 2) {
                        this.x = -this.width / 2;
                    }
                }
                
                getBounds() {
                    const X_OFFSET = (this.width - this.HITBOX_WIDTH) / 2;
                    return {
                        x: this.x + X_OFFSET, 
                        y: this.y,
                        width: this.HITBOX_WIDTH, 
                        height: this.height
                    };
                }
            }
            
            class FallingObject {
                constructor(emoji) {
                    this.size = OBJECT_SIZE; 
                    this.x = Math.random() * (canvas.width - this.size);
                    this.y = -this.size; 
                    
                    const timeElapsed = (Date.now() - startTime) / 1000;
                    const baseSpeed = 3 + Math.floor(timeElapsed / 10) * 0.5; // 10ì´ˆë§ˆë‹¤ ì†ë„ 0.5 ì¦ê°€ 
                    this.speed = baseSpeed + (Math.random() * 3) - 1.5; 
                    this.speed = Math.max(2.5, this.speed); 
                    
                    this.emoji = emoji; 
                    this.passedPlayer = false; 
                }

                draw() {
                    ctx.font = `${this.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.emoji, this.x + this.size / 2, this.y + this.size / 2);
                }

                update() {
                    this.y += this.speed;
                }
                
                getBounds() {
                    return {
                        x: this.x + POOP_HITBOX_OFFSET, 
                        y: this.y + POOP_HITBOX_OFFSET, 
                        width: POOP_HITBOX_SIZE, 
                        height: POOP_HITBOX_SIZE 
                    };
                }
            }

            class BonusObject {
                constructor() {
                    this.size = BONUS_OBJECT_SIZE; 
                    this.x = Math.random() * (canvas.width - this.size);
                    this.y = -this.size;
                    const timeElapsed = (Date.now() - startTime) / 1000;
                    this.speed = 2.5 + Math.floor(timeElapsed / 10) * 0.4;
                    this.emoji = 'ğŸª·'; 
                    this.isCollected = false; 
                }

                draw() {
                    ctx.save(); 
                    // ëª©íƒ ê¹œë¹¡ì„ íš¨ê³¼
                    ctx.globalAlpha = Math.sin(Date.now() / 150) * 0.2 + 0.8; 
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = "rgba(255, 255, 0, 1)"; 
                    ctx.font = `${this.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.emoji, this.x + this.size / 2, this.y + this.size / 2);
                    ctx.restore(); 
                }

                update() {
                    this.y += this.speed;
                }
                
                getBounds() {
                    return {
                        x: this.x,
                        y: this.y,
                        width: this.size,
                        height: this.size 
                    };
                }
            }

            let player;
            let fallingObjects = []; 
            let bonusObjects = []; 

            function initGame() {
                gameState = 'playing';
                score = 0;
                combo = 0;
                maxCombo = 0; 
                isFeverMode = false;
                feverEndTime = 0;
                lastFeverComboLevel = 0; 
                startTime = Date.now();
                lastSpawnTime = 0;
                lastMoktakSpawnTime = 0; 
                spawnInterval = 700; 
                currentStageIndex = 0;

                player = new Player();
                fallingObjects = [];
                bonusObjects = [];

                // ìŠ¤í…Œì´ì§€ ì‹œê° íš¨ê³¼ë§Œ ì—…ë°ì´íŠ¸
                updateStageVisuals(STAGES[0]); 
                updateUI();
                hideMessageBox();
                
                if (animationFrameId) cancelAnimationFrame(animationFrameId);
                gameLoop(performance.now());
            }
            
            // ìŠ¤í…Œì´ì§€ ë°°ê²½ CSSë§Œ ì—…ë°ì´íŠ¸
            function updateStageVisuals(stage) {
                STAGES.forEach(s => gameContainer.classList.remove(s.css_class));
                gameContainer.classList.add(stage.css_class);
            }

            // í”¼ë²„ ëª¨ë“œ ì‹œì‘/ì—°ì¥ (10ì´ˆ ì§€ì†)
            function startFeverMode(now, currentComboLevel) {
                isFeverMode = true;
                feverEndTime = now + FEVER_DURATION;
                lastFeverComboLevel = currentComboLevel; 
                console.log(`FEVER START/EXTEND! Combo: ${currentComboLevel}, Duration: ${FEVER_DURATION / 1000}s`);
            }

            function gameLoop(currentTime) {
                if (gameState === 'playing') {
                    update(currentTime);
                    draw();
                } else if (gameState === 'paused') {
                    draw(); 
                    drawStaticMessage('ì¼ì‹œ ì •ì§€ (ESC)');
                } else if (gameState === 'menu' || gameState === 'gameOver') {
                    draw(); 
                    drawStaticMessage();
                }

                animationFrameId = requestAnimationFrame(gameLoop);
            }

            function update(time) {
                const now = Date.now();
                const timeElapsed = (now - startTime) / 1000;
                
                // ìŠ¤í…Œì´ì§€ ë³€ê²½
                if (currentStageIndex < STAGES.length - 1 && timeElapsed >= STAGES[currentStageIndex].time) {
                    currentStageIndex++;
                    updateStageVisuals(STAGES[currentStageIndex]);
                }

                player.update();

                // í”¼ë²„ ëª¨ë“œ ì¢…ë£Œ í™•ì¸
                if (isFeverMode && now > feverEndTime) {
                    isFeverMode = false;
                    console.log("FEVER END.");
                }

                // ë˜¥ ìƒì„± ì†ë„ ì¡°ì ˆ
                spawnInterval = Math.max(150, 700 - timeElapsed * 15); 
                
                if (now - lastSpawnTime > spawnInterval) {
                    // í˜„ì¬ ìŠ¤í…Œì´ì§€ì˜ ë˜¥ ì´ëª¨ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. (ì²œêµ­ì€ 'âœ¨')
                    fallingObjects.push(new FallingObject(STAGES[currentStageIndex].emoji_poop));
                    lastSpawnTime = now;
                }

                // ì˜¤ë¸Œì íŠ¸ ì—…ë°ì´íŠ¸
                fallingObjects.forEach((obj) => {
                    obj.update();
                });
                bonusObjects.forEach((obj) => {
                    obj.update();
                });

                // ëª©íƒ ìƒì„± ë¡œì§
                const bonusObjectsOnScreen = bonusObjects.length;
                const timeSinceLastSpawn = now - lastMoktakSpawnTime;
                
                if (bonusObjectsOnScreen === 0) { 
                    if (timeSinceLastSpawn > MOKTAK_SPAWN_COOLDOWN) {
                        bonusObjects.push(new BonusObject());
                        lastMoktakSpawnTime = now; 
                        console.log("âœ¨ MOKTAK GENERATED!");
                    }
                }

                // ë˜¥ í”¼í•˜ê¸° ì„±ê³µ ì²˜ë¦¬
                let successfullyDodged = [];
                fallingObjects.forEach((obj) => {
                    // ë˜¥ì´ í”Œë ˆì´ì–´ ì˜ì—­ ì•„ë˜ë¡œ ì™„ì „íˆ ì§€ë‚˜ê°”ì„ ë•Œ
                    if (obj.y > player.y + player.height && !obj.passedPlayer) { 
                        obj.passedPlayer = true;
                        successfullyDodged.push(obj);
                    }
                });

                successfullyDodged.forEach(obj => {
                    combo++; 
                    maxCombo = Math.max(maxCombo, combo);

                    let point = 1;
                    if (isFeverMode) {
                        point *= SCORE_MULTIPLIER;
                    }
                    score += point;
                    
                    // 50ì½¤ë³´ë§ˆë‹¤ í”¼ë²„ íƒ€ì„ ë°œë™ ë¡œì§
                    const currentComboLevel = Math.floor(combo / FEVER_COMBO_INTERVAL) * FEVER_COMBO_INTERVAL;
                    
                    if (currentComboLevel > 0 && 
                        currentComboLevel > lastFeverComboLevel) {
                        
                        startFeverMode(now, currentComboLevel); 
                    }
                });


                // ëª©íƒ ë†“ì¹¨ ì²˜ë¦¬
                const missedBonus = bonusObjects.filter(obj => obj.y >= canvas.height + obj.size);
                
                if (missedBonus.length > 0) {
                    console.log("ğŸ’¥ Moktak missed! Combo reset.");
                    combo = 0;
                    isFeverMode = false;
                    lastFeverComboLevel = 0; // ì½¤ë³´ê°€ ì´ˆê¸°í™”ë˜ë©´ í”¼ë²„ ë ˆë²¨ ì¶”ì ê¸°ë„ ì´ˆê¸°í™”
                    lastMoktakSpawnTime = now; 
                }
                
                // í™”ë©´ ë°– ì˜¤ë¸Œì íŠ¸ ì œê±°
                fallingObjects = fallingObjects.filter(obj => obj.y < canvas.height + obj.size);
                bonusObjects = bonusObjects.filter(obj => obj.y < canvas.height + obj.size);


                checkCollisions();
                
                updateUI();
            }

            function checkCollisions() {
                const playerBounds = player.getBounds(); 
                let moktakCollected = [];
                const now = Date.now();

                // ë˜¥ ì¶©ëŒ ê²€ì‚¬ (ê²Œì„ ì˜¤ë²„)
                for (let i = 0; i < fallingObjects.length; i++) {
                    const obj = fallingObjects[i];
                    const objBounds = obj.getBounds();
                    
                    // AABB ì¶©ëŒ ê°ì§€
                    if (playerBounds.x < objBounds.x + objBounds.width &&
                        playerBounds.x + playerBounds.width > objBounds.x &&
                        playerBounds.y < objBounds.y + objBounds.height &&
                        playerBounds.y + playerBounds.height > objBounds.y) {
                        
                        endGame();
                        return;
                    }
                }

                // ëª©íƒ ì¶©ëŒ ê²€ì‚¬ (ì ìˆ˜ íšë“)
                for (let i = 0; i < bonusObjects.length; i++) {
                    const bonus = bonusObjects[i];
                    const bonusBounds = bonus.getBounds();

                    if (playerBounds.x < bonusBounds.x + bonusBounds.width &&
                        playerBounds.x + playerBounds.width > bonusBounds.x &&
                        playerBounds.y < bonusBounds.y + bonusBounds.height &&
                        playerBounds.y + playerBounds.height > bonusBounds.y) {
                        
                        score += BONUS_SCORE;
                        moktakCollected.push(i);
                        lastMoktakSpawnTime = now; 
                        console.log("ğŸ‰ Moktak collected!");
                    }
                }

                // ìˆ˜ì§‘ëœ ëª©íƒ ì œê±°
                for (let i = moktakCollected.length - 1; i >= 0; i--) {
                    bonusObjects.splice(moktakCollected[i], 1);
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1.0; 

                player.draw();
                fallingObjects.forEach(obj => obj.draw());
                bonusObjects.forEach(obj => obj.draw());
                
                // í”¼ë²„ ëª¨ë“œ ì‹œ ê²Œì„ í™”ë©´ ì¤‘ì•™ì— í‘œì‹œ (í¬ê¸° 30px)
                if (isFeverMode) {
                    ctx.save();
                    
                    // ê¹œë¹¡ì´ëŠ” íš¨ê³¼ë¥¼ ìœ„í•´ íˆ¬ëª…ë„ ì¡°ì ˆ
                    const alpha = Math.sin(Date.now() / 80) * 0.3 + 0.7; 
                    
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = '#FFD700'; // ê³¨ë“œ ìƒ‰ìƒ
                    ctx.shadowColor = '#FF0000';
                    ctx.shadowBlur = 15;
                    
                    ctx.font = '30px "Press Start 2P", cursive'; // í°íŠ¸ í¬ê¸° ì¡°ì •
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    ctx.fillText("FEVER TIME!", canvas.width / 2, canvas.height / 2);
                    
                    ctx.restore();
                }
            }

            function drawStaticMessage(optionalText = null) {
                 ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; 
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
                 
                 if (optionalText) {
                    ctx.fillStyle = 'white';
                    ctx.font = '30px "Press Start 2P", cursive';
                    ctx.textAlign = 'center';
                    ctx.fillText(optionalText, canvas.width / 2, canvas.height / 2);
                 }
            }

            // í”¼ë²„ ëª¨ë“œ ì‹œ ì½¤ë³´ ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ í‘œì‹œí•˜ë˜ ìƒ‰ìƒë§Œ ë³€ê²½
            function updateUI() {
                const timeElapsed = (Date.now() - startTime) / 1000;
                
                // ì ìˆ˜, ì‹œê°„ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
                scoreValue.textContent = score;
                timeValue.textContent = `${timeElapsed.toFixed(1)}s`;
                
                // ì½¤ë³´/í”¼ë²„ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (isFeverMode) {
                    comboValue.classList.add('text-yellow-300');
                    comboValue.classList.remove('text-white');
                    // í”¼ë²„ ëª¨ë“œì—¬ë„ ì½¤ë³´ ì¹´ìš´íŠ¸ ìˆ«ìë§Œ í‘œì‹œ
                    comboValue.textContent = combo; 
                } else {
                    comboValue.classList.remove('text-yellow-300');
                    comboValue.classList.add('text-white');
                    // í‰ìƒì‹œì—ëŠ” ì½¤ë³´ ìˆ«ìë§Œ í‘œì‹œ
                    comboValue.textContent = combo; 
                }
            }

            function showMessageBox(title, text, buttonText, buttonAction, isGameOver) {
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageText').innerHTML = text; 
                
                const newActionButton = actionButton.cloneNode(true);
                actionButton.parentNode.replaceChild(newActionButton, actionButton);
                actionButton = newActionButton; 
                
                actionButton.textContent = buttonText;
                actionButton.addEventListener('click', buttonAction);
                
                if (isGameOver) {
                    actionButton.classList.add('mt-4');
                    document.getElementById('messageText').innerHTML += '<br><span class="text-sm text-yellow-500">(Rí‚¤ë¥¼ ëˆŒëŸ¬ë„ ì¬ì‹œì‘ë©ë‹ˆë‹¤.)</span>';
                }
                
                messageBox.classList.remove('hidden');
                window.actionButton = actionButton;
            }

            function hideMessageBox() {
                messageBox.classList.add('hidden');
            }

            function endGame() {
                gameState = 'gameOver';
                cancelAnimationFrame(animationFrameId);
                const finalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                const finalMaxCombo = maxCombo; 
                
                if (score > 0) {
                    saveScore(score, parseFloat(finalTime));
                }
                
                showMessageBox(
                    'ê²Œì„ ì˜¤ë²„! ğŸ˜­', 
                    `ë‹¹ì‹ ì˜ ìƒì¡´ ì‹œê°„: ${finalTime}ì´ˆ<br>íšë“ ì ìˆ˜: ${score}ì <br>ìµœëŒ€ ì½¤ë³´: ${finalMaxCombo}íšŒ`,
                    'ë‹¤ì‹œ ì‹œì‘',
                    initGame,
                    true 
                );
                isFeverMode = false;
                updateUI();
            }
            
            function togglePause() {
                if (gameState === 'playing') {
                    gameState = 'paused';
                    showMessageBox(
                        'PAUSED', 
                        'ì ì‹œ ì‰¬ê³  ìˆêµ°ìš”! ë‹¤ì‹œ ì‹œì‘í•˜ë ¤ë©´ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ ESC í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.',
                        'ê³„ì†í•˜ê¸°',
                        togglePause,
                        false
                    );
                } else if (gameState === 'paused') {
                    gameState = 'playing';
                    hideMessageBox();
                    gameLoop(performance.now());
                }
            }


            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (í‚¤ë³´ë“œ ë° í„°ì¹˜)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (gameState === 'playing' || gameState === 'paused') {
                        togglePause();
                    }
                }
                
                if (gameState === 'playing') {
                    if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = true;
                    if (e.key === 'ArrowRight' || e.key === 'd') keys.right = true;
                } else if (gameState === 'gameOver' && (e.key === 'r' || e.key === 'R')) { 
                    initGame();
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft' || e.key === 'a') keys.left = false;
                if (e.key === 'ArrowRight' || e.key === 'd') keys.right = false;
            });
            
            const leftButton = document.getElementById('leftButton');
            const rightButton = document.getElementById('rightButton');
            
            function handleInputStart(e, control) {
                e.preventDefault();
                if (gameState === 'playing') {
                    if (e.type.startsWith('touch')) {
                        touchControls[control] = true;
                    } else {
                        keys[control] = true;
                    }
                }
            }
            
            function handleInputEnd(e, control) {
                e.preventDefault();
                if (e.type.startsWith('touch')) {
                    touchControls[control] = false;
                } else {
                    keys[control] = false;
                }
            }
            
            leftButton.addEventListener('touchstart', (e) => handleInputStart(e, 'left'), { passive: false });
            leftButton.addEventListener('touchend', (e) => handleInputEnd(e, 'left'));
            rightButton.addEventListener('touchstart', (e) => handleInputStart(e, 'right'), { passive: false });
            rightButton.addEventListener('touchend', (e) => handleInputEnd(e, 'right'));

            leftButton.addEventListener('mousedown', (e) => handleInputStart(e, 'left'));
            leftButton.addEventListener('mouseup', (e) => handleInputEnd(e, 'left'));
            rightButton.addEventListener('mousedown', (e) => handleInputStart(e, 'right'));
            rightButton.addEventListener('mouseup', (e) => handleInputEnd(e, 'right'));


            document.getElementById('actionButton').addEventListener('click', initGame);

            function showMenu() {
                gameState = 'menu';
                player = new Player(); 
                resizeCanvas(); 
                draw();
                
                showMessageBox(
                    'ë˜¥ í”¼í•˜ê¸° ê²Œì„', 
                    'ì¢Œìš° í™”ì‚´í‘œ/í„°ì¹˜ ë²„íŠ¼ìœ¼ë¡œ í”Œë ˆì´ì–´ë¥¼ ì›€ì§ì—¬ í”¼í•˜ì„¸ìš”!<br>íˆíŠ¸ë°•ìŠ¤ê°€ ì¤„ì–´ë“¤ì–´ ë” ì •ë°€í•œ ì¡°ì‘ì´ ê°€ëŠ¥í•´ìš”!',
                    'ê²Œì„ ì‹œì‘',
                    initGame,
                    false
                );
            }
            
            showMenu();
        });
    </script>
</body>
</html>
